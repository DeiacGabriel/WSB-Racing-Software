@page "/events/{EventId:long}"
@using WSB_Management.Models
@using WSB_Management.Services
@using WSB_Management.Components.Dialogs
@using WSB_Management.Components.Customs
@using BlazorBootstrap


<PageTitle>WSB-Sport - @CurrentEvent?.Name</PageTitle>

<style>
    .grid-compact td { padding-top: 4px; padding-bottom: 4px; vertical-align: middle; }
    .flag-icon { height: 16px; width: auto; }
    .status-registered { background-color: #e8f5e9 !important; }
    .status-waitlist { background-color: #fff3e0 !important; }
    .status-absent { background-color: #f5f5f5 !important; }
    .status-additional { background-color: #e3f2fd !important; }
    .status-reminded { background-color: #ffcdd2 !important; }
    .status-unpaid { background-color: #fff9c4 !important; }
    .day-badge { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 11px; font-weight: 500; }
    .day-active { background-color: #1976d2; color: white; }
    .day-inactive { background-color: #e0e0e0; color: #9e9e9e; }
    .participant-row { cursor: pointer; transition: all 0.2s; }
    .participant-row:hover { background-color: #e3f2fd !important; }
    .kassa-card { background: linear-gradient(135deg, #1976d2, #1565c0); }
    .kassa-card-danger { background: linear-gradient(135deg, #d32f2f, #c62828); }
    .kassa-card-success { background: linear-gradient(135deg, #388e3c, #2e7d32); }
</style>

<div class="container-fluid p-3">
    @* Header mit Event-Auswahl *@
    <div class="row mb-3">
        <div class="col-12">
            <MudPaper Class="pa-3" Elevation="2">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div class="d-flex align-items-center gap-3">
                        <MudIcon Icon="@Icons.Material.Filled.SportsMotorsports" Size="Size.Large" Color="Color.Primary" />
                        <div>
                            <MudText Typo="Typo.h5" Class="fw-bold">@CurrentEvent?.Name</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @CurrentEvent?.Validfrom.ToString("dd.MM.yyyy") - @CurrentEvent?.Validuntil.ToString("dd.MM.yyyy")
                            </MudText>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center gap-2">
                        @* Event Auswahl *@
                        <MudSelect T="long" Value="@EventId" ValueChanged="@OnEventSelected" Label="Event wechseln"
                                   Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width: 200px;">
                            @foreach (var ev in AllEvents)
                            {
                                <MudSelectItem Value="@ev.Id">@ev.Name (@ev.Validfrom.ToString("dd.MM"))</MudSelectItem>
                            }
                        </MudSelect>
                        
                        @* Action Buttons *@
                        <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary">
                            <MudButton StartIcon="@Icons.Material.Filled.BarChart" OnClick="@OpenStatistics">
                                Statistik
                            </MudButton>
                            <MudButton StartIcon="@Icons.Material.Filled.Print" OnClick="@OpenPrintDialog">
                                Drucken
                            </MudButton>
                            <MudButton StartIcon="@Icons.Material.Filled.Pin" OnClick="@OpenStartNumbers">
                                Startnr.
                            </MudButton>
                            <MudButton StartIcon="@Icons.Material.Filled.FileDownload">
                                Export
                            </MudButton>
                        </MudButtonGroup>
                    </div>
                </div>
            </MudPaper>
        </div>
    </div>
    
    @* Statistik Karten *@
    <div class="row g-3 mb-3">
        @* Status Karte *@
        <div class="col-12 col-md-6 col-xl-3">
            <MudPaper Class="pa-3 h-100" Elevation="2">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.People" Color="Color.Error" />
                    <MudText Typo="Typo.h6">Status</MudText>
                </div>
                <MudSimpleTable Dense="true" Hover="true">
                    <tbody>
                        <tr>
                            <td>Gemeldet</td>
                            <td class="text-end"><MudChip T="string" Size="Size.Small" Color="Color.Success">@Statistics.TotalRegistrations</MudChip></td>
                        </tr>
                        <tr>
                            <td>Zusatzbikes</td>
                            <td class="text-end"><MudChip T="string" Size="Size.Small" Color="Color.Info">@Statistics.TotalAdditionalBikes</MudChip></td>
                        </tr>
                        <tr>
                            <td>Warteliste</td>
                            <td class="text-end"><MudChip T="string" Size="Size.Small" Color="Color.Warning">@Statistics.TotalWaitlist</MudChip></td>
                        </tr>
                        <tr>
                            <td>Abwesend</td>
                            <td class="text-end"><MudChip T="string" Size="Size.Small" Color="Color.Default">@Statistics.TotalAbsent</MudChip></td>
                        </tr>
                        <tr class="fw-bold">
                            <td>Noch frei</td>
                            <td class="text-end text-danger">@Statistics.FreeSpots</td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudPaper>
        </div>
        
        @* Tage Übersicht *@
        <div class="col-12 col-md-6 col-xl-3">
            <MudPaper Class="pa-3 h-100" Elevation="2">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Color="Color.Warning" />
                    <MudText Typo="Typo.h6">Tage</MudText>
                </div>
                @foreach (var day in Statistics.DayStatistics)
                {
                    <div class="d-flex justify-content-between align-items-center py-1">
                        <span>@Event.GetGermanDayName(day.Date) @day.Date.ToString("dd.MM")</span>
                        <div class="d-flex gap-1">
                            <MudChip T="string" Size="Size.Small" Color="Color.Success">@day.Registered</MudChip>
                            @if (day.Waitlist > 0)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Warning">@day.Waitlist</MudChip>
                            }
                        </div>
                    </div>
                }
            </MudPaper>
        </div>
        
        @* Top Marken *@
        <div class="col-12 col-md-6 col-xl-3">
            <MudPaper Class="pa-3 h-100" Elevation="2">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.DirectionsBike" Color="Color.Success" />
                    <MudText Typo="Typo.h6">Top Marken</MudText>
                </div>
                @foreach (var brand in Statistics.BrandDistribution.OrderByDescending(b => b.Value).Take(5))
                {
                    <div class="d-flex justify-content-between align-items-center py-1">
                        <span>@brand.Key</span>
                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary">@brand.Value</MudChip>
                    </div>
                }
            </MudPaper>
        </div>
        
        @* Auslastung *@
        <div class="col-12 col-md-6 col-xl-3">
            <MudPaper Class="pa-3 h-100" Elevation="2">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Speed" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">Auslastung</MudText>
                </div>
                <div class="text-center">
                    <MudText Typo="Typo.h2" Color="@GetOccupancyColor(Statistics.OccupancyPercent)">
                        @Statistics.OccupancyPercent.ToString("F0")%
                    </MudText>
                    <MudProgressLinear Value="@Statistics.OccupancyPercent" Color="@GetOccupancyMudColor(Statistics.OccupancyPercent)"
                                       Size="Size.Large" Rounded="true" Class="mt-2" />
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                        @Statistics.TotalRegistrations / @Statistics.MaxCapacity
                    </MudText>
                </div>
            </MudPaper>
        </div>
    </div>
    
    @* Hauptbereich: Teilnehmerliste *@
    <div class="row">
        <div class="col-12">
            <MudPaper Class="pa-0" Elevation="2">
                @* Toolbar *@
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                    <div class="d-flex align-items-center gap-2">
                        <MudText Typo="Typo.h6">
                            Teilnehmerliste (@CustomerSummaries.Count Teilnehmer)
                        </MudText>
                        <MudButton StartIcon="@Icons.Material.Filled.PersonAdd" Variant="Variant.Filled" Color="Color.Success"
                                   OnClick="@OpenAddCustomerDialog">
                            Kunde hinzufügen
                        </MudButton>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        @* Filter *@
                        <MudChipSet T="ParticipationStatus?" SelectedValue="@StatusFilter" SelectedValueChanged="@((val) => FilterByStatus(val))"
                                    SelectionMode="SelectionMode.SingleSelection" Variant="Variant.Outlined">
                            <MudChip T="ParticipationStatus?" Value="@((ParticipationStatus?)null)" Default="true">Alle</MudChip>
                            <MudChip T="ParticipationStatus?" Value="@ParticipationStatus.Registered" Color="Color.Success">Angemeldet</MudChip>
                            <MudChip T="ParticipationStatus?" Value="@ParticipationStatus.Waitlist" Color="Color.Warning">Warteliste</MudChip>
                            <MudChip T="ParticipationStatus?" Value="@ParticipationStatus.Absent" Color="Color.Default">Abwesend</MudChip>
                        </MudChipSet>
                        
                        <MudTextField T="string" @bind-Value="SearchText" Placeholder="Suche..."
                                      Variant="Variant.Outlined" Margin="Margin.Dense"
                                      Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search"
                                      Immediate="true" DebounceInterval="300" />
                    </div>
                </div>
                
                @* Tabelle *@
                <div style="max-height: 500px; overflow-y: auto;">
                    <MudSimpleTable Dense="true" Hover="true" Class="mb-0">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>Name</th>
                                <th>Startnr.</th>
                                <th>Gruppe</th>
                                <th>Tage</th>
                                <th>Bike</th>
                                <th>Transponder</th>
                                <th>Status</th>
                                <th>Bezahlt</th>
                                <th style="width: 100px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var summary in FilteredCustomers)
                            {
                                var rowClass = GetRowClass(summary);
                                <tr class="participant-row @rowClass" @onclick="@(() => SelectCustomer(summary))">
                                    <td>
                                        @if (!HasValidWaiver(summary.CustomerId))
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Small" 
                                                     Title="Verzichtserklärung fehlt" />
                                        }
                                    </td>
                                    <td>
                                        <div class="fw-bold">@summary.Customer?.Contact?.Surname @summary.Customer?.Contact?.Firstname</div>
                                        @if (!string.IsNullOrEmpty(summary.Customer?.Mail))
                                        {
                                            <small class="text-muted">@summary.Customer.Mail</small>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(GetStartNumber(summary)))
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary">@GetStartNumber(summary)</MudChip>
                                        }
                                    </td>
                                    <td>
                                        <MudChip T="string" Size="Size.Small" Color="@GetGroupColor(summary.Customer?.Gruppe?.Name)">
                                            @(summary.Customer?.Gruppe?.Name ?? "-")
                                        </MudChip>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            @foreach (var day in CurrentEvent?.GetEventDays() ?? new List<DateTime>())
                                            {
                                                var isActive = summary.ParticipationDays.Contains(day.Date);
                                                <div class="day-badge @(isActive ? "day-active" : "day-inactive")">
                                                    @Event.GetGermanDayName(day).Substring(0, 2)
                                                </div>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        @(summary.Customer?.Bike?.BikeType?.Brand?.Name ?? "-")
                                        <small class="text-muted d-block">@(summary.Customer?.Bike?.BikeType?.Name ?? "")</small>
                                    </td>
                                    <td>
                                        @if (summary.PrimaryParticipation?.Transponder != null)
                                        {
                                            <span>@summary.PrimaryParticipation.Transponder.Number</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(summary.PrimaryParticipation?.Status ?? ParticipationStatus.Registered)">
                                            @GetStatusText(summary.PrimaryParticipation?.Status ?? ParticipationStatus.Registered)
                                        </MudChip>
                                    </td>
                                    <td>
                                        @if (summary.AllParticipations.All(p => p.IsPaid))
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                        }
                                        else
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" Size="Size.Small" />
                                        }
                                    </td>
                                    <td @onclick:stopPropagation="true">
                                        <MudIconButton Icon="@Icons.Material.Filled.PointOfSale" Color="Color.Primary" Size="Size.Small"
                                                       OnClick="@(() => OpenKassa(summary))" title="Kassa" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Email" Color="Color.Secondary" Size="Size.Small"
                                                       OnClick="@(() => OpenEmail(summary))" title="Email" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                                       OnClick="@(() => DeleteCustomerParticipations(summary))" title="Löschen" />
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                </div>
            </MudPaper>
        </div>
    </div>
    
    @* Detail Panel (wenn Kunde ausgewählt) *@
    @if (SelectedSummary != null)
    {
        <MudPaper Class="pa-4 mt-3" Elevation="3" Style="border-left: 4px solid #1976d2;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <MudText Typo="Typo.h5">
                    <MudIcon Icon="@Icons.Material.Filled.Person" Class="me-2" />
                    @SelectedSummary.Customer?.Contact?.Surname @SelectedSummary.Customer?.Contact?.Firstname
                </MudText>
                <div class="d-flex gap-2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.PointOfSale"
                               OnClick="@(() => OpenKassa(SelectedSummary))">
                        KASSA
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Save"
                               OnClick="@SaveCurrentCustomer">
                        SPEICHERN
                    </MudButton>
                    <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="@(() => SelectedSummary = null)" />
                </div>
            </div>
            
            <MudGrid>
                @* Buchungstage *@
                <MudItem xs="12" md="4">
                    <MudPaper Class="pa-3" Elevation="1">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold mb-2">Buchungstage</MudText>
                        @foreach (var day in CurrentEvent?.GetEventDays() ?? new List<DateTime>())
                        {
                            var isBooked = SelectedSummary.ParticipationDays.Contains(day.Date);
                            <div class="d-flex justify-content-between align-items-center py-1">
                                <MudCheckBox T="bool" Value="@isBooked" ValueChanged="@((val) => ToggleDay(day, val))"
                                             Label="@($"{Event.GetGermanDayName(day)} {day:dd.MM}")" Color="Color.Primary" />
                                <span class="text-muted">@GetDayPrice(day).ToString("C2")</span>
                            </div>
                        }
                    </MudPaper>
                </MudItem>
                
                @* Kundendaten *@
                <MudItem xs="12" md="4">
                    <MudPaper Class="pa-3" Elevation="1">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold mb-2">Daten</MudText>
                        <MudGrid>
                            <MudItem xs="6">
                                <MudTextField T="string" @bind-Value="SelectedSummary.Customer!.Contact!.Firstname"
                                              Label="Vorname" Variant="Variant.Outlined" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6">
                                <MudTextField T="string" @bind-Value="SelectedSummary.Customer!.Contact!.Surname"
                                              Label="Nachname" Variant="Variant.Outlined" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6">
                                <MudTextField T="string" @bind-Value="SelectedSummary.Customer!.Startnumber"
                                              Label="Startnr." Variant="Variant.Outlined" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6">
                                <MudSelect T="Gruppe" @bind-Value="SelectedSummary.Customer!.Gruppe"
                                           Label="Gruppe" Variant="Variant.Outlined" Margin="Margin.Dense">
                                    @foreach (var grp in Gruppen)
                                    {
                                        <MudSelectItem Value="@grp">@grp.Name</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12">
                                <MudTextField T="string" @bind-Value="LaptimeString" Label="Rundenzeit"
                                              Variant="Variant.Outlined" Margin="Margin.Dense" Placeholder="0:00.000" />
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudItem>
                
                @* Status *@
                <MudItem xs="12" md="4">
                    @{
                        var statusCardClass = HasOpenPayments(SelectedSummary) ? "pa-3 h-100 kassa-card-danger" : "pa-3 h-100 kassa-card-success";
                    }
                    <MudPaper Class="@statusCardClass" Elevation="1">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold mb-2 text-white">Kassa Status</MudText>
                        
                        @if (!HasValidWaiver(SelectedSummary.CustomerId))
                        {
                            <MudAlert Severity="Severity.Error" Dense="true" Class="mb-2">
                                Verzichtserklärung fehlt!
                            </MudAlert>
                        }
                        
                        <div class="text-white">
                            <div class="d-flex justify-content-between">
                                <span>Zu zahlen:</span>
                                <span class="fw-bold">@CalculateTotal(SelectedSummary).ToString("C2")</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Bezahlt:</span>
                                <span>@CalculatePaid(SelectedSummary).ToString("C2")</span>
                            </div>
                            <hr class="my-2 border-light" />
                            <div class="d-flex justify-content-between fs-5 fw-bold">
                                <span>OFFEN:</span>
                                <span>@CalculateOpen(SelectedSummary).ToString("C2")</span>
                            </div>
                        </div>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }
</div>
