@page "/management/types"
@using WSB_Management.Models
@using WSB_Management.Services
@using MudBlazor


<PageTitle>WSB-Sport - Motorrad Typen & Klassen</PageTitle>

<style>
    .type-card { transition: all 0.2s; cursor: pointer; }
    .type-card:hover { background-color: #e3f2fd !important; }
    .type-card.selected { background-color: #bbdefb !important; border-left: 4px solid #1976d2; }
</style>

<div class="container-fluid p-3">
    @* Header *@
    <MudPaper Class="pa-3 mb-3" Elevation="2">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center gap-3">
                <MudIcon Icon="@Icons.Material.Filled.TwoWheeler" Size="Size.Large" Color="Color.Primary" />
                <div>
                    <MudText Typo="Typo.h5" Class="fw-bold">Motorrad Typen & Klassen</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @BikeTypes.Count Typen in @Klassen.Count Klassen
                    </MudText>
                </div>
            </div>
        </div>
    </MudPaper>
    
    <div class="row">
        @* Klassen (linke Spalte) *@
        <div class="col-12 col-lg-4">
            <MudPaper Class="pa-0" Elevation="2">
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                    <MudText Typo="Typo.h6">Klassen</MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.Add" OnClick="@AddNewKlasse">
                        Neu
                    </MudButton>
                </div>
                
                <MudList T="Klasse" Dense="true" Class="py-0">
                    @foreach (var klasse in Klassen)
                    {
                        var isSelected = SelectedKlasse?.Id == klasse.Id;
                        <MudListItem T="Klasse" Class="@($"type-card {(isSelected ? "selected" : "")}")"
                                     OnClick="@(() => SelectKlasse(klasse))">
                            <div class="d-flex justify-content-between align-items-center w-100">
                                <div class="d-flex align-items-center gap-2">
                                    <MudIcon Icon="@Icons.Material.Filled.Category" Color="Color.Secondary" Size="Size.Small" />
                                    <MudText>@klasse.Bezeichnung</MudText>
                                </div>
                                <span @onclick="@(() => DeleteKlasse(klasse.Id))" @onclick:stopPropagation="true">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" />
                                </span>
                            </div>
                        </MudListItem>
                        <MudDivider />
                    }
                </MudList>
                
                @* Klasse Edit *@
                @if (SelectedKlasse != null)
                {
                    <div class="pa-3 border-top" style="background-color: #fafafa;">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudTextField T="string" @bind-Value="SelectedKlasse.Bezeichnung" Label="Bezeichnung"
                                              Variant="Variant.Outlined" Margin="Margin.Dense" FullWidth="true" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.Save" OnClick="@SaveKlasse">
                                    Klasse Speichern
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                    </div>
                }
            </MudPaper>
        </div>
        
        @* Bike Types (rechte Spalte) *@
        <div class="col-12 col-lg-8 mt-3 mt-lg-0">
            <MudPaper Class="pa-0" Elevation="2">
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom flex-wrap gap-2">
                    <MudText Typo="Typo.h6">Motorrad Typen</MudText>
                    <div class="d-flex gap-2 align-items-center">
                        <MudTextField T="string" @bind-Value="SearchText" Placeholder="Suchen..."
                                      Variant="Variant.Outlined" Margin="Margin.Dense" Style="width: 180px;"
                                      Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search"
                                      Immediate="true" />
                        <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small"
                                   StartIcon="@Icons.Material.Filled.Add" OnClick="@AddNewBikeType">
                            Neuer Typ
                        </MudButton>
                    </div>
                </div>
                
                <div style="max-height: 500px; overflow-y: auto;">
                    <MudSimpleTable Dense="true" Hover="true">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th>Marke</th>
                                <th>Typ Name</th>
                                <th>Klasse</th>
                                <th style="width: 80px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var bt in FilteredBikeTypes)
                            {
                                var isSelected = SelectedBikeType?.Id == bt.Id;
                                <tr class="type-card @(isSelected ? "selected" : "")"
                                    @onclick="@(() => SelectBikeType(bt))"
                                    style="cursor: pointer;">
                                    <td>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">
                                            @bt.Brand?.Name
                                        </MudChip>
                                    </td>
                                    <td class="fw-bold">@bt.Name</td>
                                    <td>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary">
                                            @bt.Klasse?.Bezeichnung
                                        </MudChip>
                                    </td>
                                    <td @onclick:stopPropagation="true">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                                       OnClick="@(() => DeleteBikeType(bt.Id))" />
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                </div>
                
                @* BikeType Edit *@
                @if (SelectedBikeType != null)
                {
                    <div class="pa-3 border-top" style="background-color: #fafafa;">
                        <MudGrid>
                            <MudItem xs="12" md="4">
                                <MudSelect T="Brand" @bind-Value="SelectedBrand" Label="Marke"
                                           Variant="Variant.Outlined" Margin="Margin.Dense"
                                           ToStringFunc="@(b => b?.Name ?? "")" Clearable="true">
                                    @foreach (var b in Brands)
                                    {
                                        <MudSelectItem Value="@b">@b.Name</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudTextField T="string" @bind-Value="SelectedBikeType.Name" Label="Typ Name"
                                              Variant="Variant.Outlined" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudSelect T="Klasse" @bind-Value="SelectedBikeTypeKlasse" Label="Klasse"
                                           Variant="Variant.Outlined" Margin="Margin.Dense"
                                           ToStringFunc="@(k => k?.Bezeichnung ?? "")" Clearable="true">
                                    @foreach (var k in Klassen)
                                    {
                                        <MudSelectItem Value="@k">@k.Bezeichnung</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12">
                                <div class="d-flex gap-2">
                                    <MudButton Variant="Variant.Filled" Color="Color.Success"
                                               StartIcon="@Icons.Material.Filled.Save" OnClick="@SaveBikeType">
                                        Typ Speichern
                                    </MudButton>
                                    <MudButton Variant="Variant.Outlined" Color="Color.Default"
                                               OnClick="@(() => SelectedBikeType = null)">
                                        Abbrechen
                                    </MudButton>
                                </div>
                            </MudItem>
                        </MudGrid>
                    </div>
                }
            </MudPaper>
        </div>
    </div>
</div>
