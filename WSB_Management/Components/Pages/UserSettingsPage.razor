@page "/settings/users"
@using WSB_Management.Models
@using WSB_Management.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "SuperAdmin")]

@inject AuthService AuthService
@inject ILogger<UserSettingsPage> Logger

<PageTitle>WSB-Sport - Benutzerverwaltung</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>üë• Benutzerverwaltung</h2>
            <p class="text-muted">Verwalte die Administratoren, die sich am System anmelden k√∂nnen.</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" @onclick="ShowCreateDialog">
                <i class="bi bi-plus-lg"></i> Neuer Benutzer
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laden...</span>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>E-Mail</th>
                            <th>Benutzername</th>
                            <th>Rolle</th>
                            <th>Status</th>
                            <th>Letzter Login</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in users)
                        {
                            <tr>
                                <td>@user.FullName</td>
                                <td>@user.Email</td>
                                <td>@user.Username</td>
                                <td>
                                    @if (user.IsSuperAdmin)
                                    {
                                        <span class="badge bg-danger">Super-Admin</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-primary">Admin</span>
                                    }
                                </td>
                                <td>
                                    @if (user.IsActive)
                                    {
                                        <span class="badge bg-success">Aktiv</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Inaktiv</span>
                                    }
                                </td>
                                <td>@(user.LastLogin?.ToString("dd.MM.yyyy HH:mm") ?? "Nie")</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => ShowEditDialog(user)" title="Bearbeiten">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning me-1" @onclick="() => ShowPasswordDialog(user)" title="Passwort √§ndern">
                                        <i class="bi bi-key"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmDelete(user)" title="L√∂schen" disabled="@(user.IsSuperAdmin && superAdminCount <= 1)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                @if (!users.Any())
                {
                    <div class="alert alert-info">
                        Keine Benutzer vorhanden. Erstelle einen neuen Benutzer.
                    </div>
                }
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="alert @(isError ? "alert-danger" : "alert-success") alert-dismissible fade show mt-3" role="alert">
            @statusMessage
            <button type="button" class="btn-close" @onclick="() => statusMessage = string.Empty"></button>
        </div>
    }
</div>

<!-- Create/Edit Dialog -->
@if (showUserDialog)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isEditMode ? "Benutzer bearbeiten" : "Neuer Benutzer")</h5>
                    <button type="button" class="btn-close" @onclick="CloseDialog"></button>
                </div>
                <EditForm Model="@editUser" OnValidSubmit="SaveUser">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Vorname</label>
                            <InputText @bind-Value="editUser.FirstName" class="form-control" />
                            <ValidationMessage For="@(() => editUser.FirstName)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nachname</label>
                            <InputText @bind-Value="editUser.LastName" class="form-control" />
                            <ValidationMessage For="@(() => editUser.LastName)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">E-Mail</label>
                            <InputText @bind-Value="editUser.Email" class="form-control" type="email" />
                            <ValidationMessage For="@(() => editUser.Email)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Benutzername</label>
                            <InputText @bind-Value="editUser.Username" class="form-control" />
                            <ValidationMessage For="@(() => editUser.Username)" />
                        </div>
                        @if (!isEditMode)
                        {
                            <div class="mb-3">
                                <label class="form-label">Passwort</label>
                                <InputText @bind-Value="newPassword" class="form-control" type="password" />
                            </div>
                        }
                        <div class="mb-3">
                            <div class="form-check">
                                <InputCheckbox @bind-Value="editUser.IsSuperAdmin" class="form-check-input" id="isSuperAdmin" />
                                <label class="form-check-label" for="isSuperAdmin">Super-Admin</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <InputCheckbox @bind-Value="editUser.IsActive" class="form-check-input" id="isActive" />
                                <label class="form-check-label" for="isActive">Aktiv</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseDialog">Abbrechen</button>
                        <button type="submit" class="btn btn-primary">Speichern</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<!-- Password Dialog -->
@if (showPasswordDialog)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Passwort √§ndern f√ºr @selectedUser?.FullName</h5>
                    <button type="button" class="btn-close" @onclick="ClosePasswordDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Neues Passwort</label>
                        <input type="password" @bind="newPassword" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Passwort best√§tigen</label>
                        <input type="password" @bind="confirmPassword" class="form-control" />
                    </div>
                    @if (!string.IsNullOrEmpty(passwordError))
                    {
                        <div class="alert alert-danger">@passwordError</div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="ClosePasswordDialog">Abbrechen</button>
                    <button type="button" class="btn btn-primary" @onclick="ChangePassword">Passwort √§ndern</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Dialog -->
@if (showDeleteDialog)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Benutzer l√∂schen</h5>
                    <button type="button" class="btn-close" @onclick="() => showDeleteDialog = false"></button>
                </div>
                <div class="modal-body">
                    <p>M√∂chtest du den Benutzer <strong>@selectedUser?.FullName</strong> wirklich l√∂schen?</p>
                    <p class="text-danger">Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showDeleteDialog = false">Abbrechen</button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteUser">L√∂schen</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<AdminUser> users = new();
    private AdminUser editUser = new();
    private AdminUser? selectedUser;
    private string newPassword = string.Empty;
    private string confirmPassword = string.Empty;
    private string passwordError = string.Empty;
    private string statusMessage = string.Empty;
    private bool isError = false;
    private bool isLoading = true;
    private bool showUserDialog = false;
    private bool showPasswordDialog = false;
    private bool showDeleteDialog = false;
    private bool isEditMode = false;
    private int superAdminCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        isLoading = true;
        try
        {
            users = await AuthService.GetAllUsersAsync();
            superAdminCount = users.Count(u => u.IsSuperAdmin);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fehler beim Laden der Benutzer");
            ShowStatus("Fehler beim Laden der Benutzer", true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowCreateDialog()
    {
        editUser = new AdminUser { IsActive = true };
        newPassword = string.Empty;
        isEditMode = false;
        showUserDialog = true;
    }

    private void ShowEditDialog(AdminUser user)
    {
        editUser = new AdminUser
        {
            Id = user.Id,
            Username = user.Username,
            Email = user.Email,
            FirstName = user.FirstName,
            LastName = user.LastName,
            IsActive = user.IsActive,
            IsSuperAdmin = user.IsSuperAdmin
        };
        isEditMode = true;
        showUserDialog = true;
    }

    private void CloseDialog()
    {
        showUserDialog = false;
        editUser = new AdminUser();
        newPassword = string.Empty;
    }

    private async Task SaveUser()
    {
        try
        {
            bool success;
            if (isEditMode)
            {
                success = await AuthService.UpdateUserAsync(editUser);
            }
            else
            {
                if (string.IsNullOrEmpty(newPassword))
                {
                    ShowStatus("Passwort ist erforderlich", true);
                    return;
                }
                success = await AuthService.CreateUserAsync(editUser, newPassword);
            }

            if (success)
            {
                ShowStatus(isEditMode ? "Benutzer aktualisiert" : "Benutzer erstellt", false);
                CloseDialog();
                await LoadUsers();
            }
            else
            {
                ShowStatus("Speichern fehlgeschlagen. E-Mail m√∂glicherweise bereits vergeben.", true);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fehler beim Speichern des Benutzers");
            ShowStatus("Fehler beim Speichern", true);
        }
    }

    private void ShowPasswordDialog(AdminUser user)
    {
        selectedUser = user;
        newPassword = string.Empty;
        confirmPassword = string.Empty;
        passwordError = string.Empty;
        showPasswordDialog = true;
    }

    private void ClosePasswordDialog()
    {
        showPasswordDialog = false;
        selectedUser = null;
        newPassword = string.Empty;
        confirmPassword = string.Empty;
        passwordError = string.Empty;
    }

    private async Task ChangePassword()
    {
        if (string.IsNullOrEmpty(newPassword))
        {
            passwordError = "Passwort ist erforderlich";
            return;
        }

        if (newPassword != confirmPassword)
        {
            passwordError = "Passw√∂rter stimmen nicht √ºberein";
            return;
        }

        if (newPassword.Length < 6)
        {
            passwordError = "Passwort muss mindestens 6 Zeichen lang sein";
            return;
        }

        try
        {
            var user = selectedUser!;
            user.PasswordHash = string.Empty; // Will be set by UpdateUserAsync
            var success = await AuthService.UpdateUserAsync(user, newPassword);

            if (success)
            {
                ShowStatus("Passwort ge√§ndert", false);
                ClosePasswordDialog();
            }
            else
            {
                passwordError = "Fehler beim √Ñndern des Passworts";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fehler beim √Ñndern des Passworts");
            passwordError = "Fehler beim √Ñndern des Passworts";
        }
    }

    private void ConfirmDelete(AdminUser user)
    {
        selectedUser = user;
        showDeleteDialog = true;
    }

    private async Task DeleteUser()
    {
        if (selectedUser == null) return;

        try
        {
            var success = await AuthService.DeleteUserAsync(selectedUser.Id);
            if (success)
            {
                ShowStatus("Benutzer gel√∂scht", false);
                await LoadUsers();
            }
            else
            {
                ShowStatus("L√∂schen fehlgeschlagen. Letzter Super-Admin kann nicht gel√∂scht werden.", true);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fehler beim L√∂schen des Benutzers");
            ShowStatus("Fehler beim L√∂schen", true);
        }
        finally
        {
            showDeleteDialog = false;
            selectedUser = null;
        }
    }

    private void ShowStatus(string message, bool error)
    {
        statusMessage = message;
        isError = error;
    }
}
