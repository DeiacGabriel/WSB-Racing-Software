@using WSB_Management.Components.Customs
@using WSB_Management.Components.Layout
@using System.ComponentModel.DataAnnotations
@using WSB_Management.Models

@page "/customer"
@rendermode InteractiveServer
@layout MainLayout

<PageTitle>WSB-Sport - Kunde</PageTitle>
<HeadContent>
    <link rel="stylesheet" href="@Assets["customer.css"]" />
</HeadContent>
<div class="group-div" style="height: 34rem;">
    <div class="kunden-liste-header">
        <p class="kunden-titel">Liste aller Kunden</p>
        <div class="header-btn">
            <button class="excel-btn"><img src="./download_icon.svg" alt="Dw Icon">Export to Excel</button>
            <button class="regis-kunde-btn"><img src="./add_icon.svg" alt="Add Icon">Kunde anmelden</button>
        </div>
    </div>
    <div class="grid-scroll-wrapper">
        <Grid TItem="Customer"
              @ref="grid"
              Class="table table-hover table-bordered table-striped"
              AllowSorting="true"
              AllowFiltering="true"
              AllowSelection="true"
              Responsive="true"
              AllowPaging="false"
              DataProvider="CustomerDataProvider"
              RowKeySelector="c => c.Id"
              SelectionMode="GridSelectionMode.Single"
              SelectedItemsChanged="OnSelectedItemsChanged"
              Style="height:28.5rem;">

            <GridColumns>
                <GridColumn TItem="Customer" HeaderText="Id" PropertyName="Id" Filterable="false" SortKeySelector="x => x.Id">
                    @context.Id
                </GridColumn>

                <GridColumn TItem="Customer" HeaderText="Nachname" PropertyName="Surname" SortKeySelector="x => x.Contact.Surname">
                    @context.Contact.Surname
                </GridColumn>

                <GridColumn TItem="Customer" HeaderText="Vorname" PropertyName="Firstname" SortKeySelector="x => x.Contact.Firstname">
                    @context.Contact.Firstname
                </GridColumn>

                <GridColumn TItem="Customer" HeaderText="Email" PropertyName="Mail" SortKeySelector="x => x.Mail">
                    @context.Mail
                </GridColumn>

                <GridColumn TItem="Customer" HeaderText="Telefon" PropertyName="Phonenumber" SortKeySelector="x => x.Contact.Phonenumber">
                    @context.Contact.Phonenumber
                </GridColumn>

                <GridColumn TItem="Customer" HeaderText="Geburtsdatum" PropertyName="Birthdate" SortKeySelector="x => x.Birthdate">
                    @context.Birthdate.ToString("dd.MM.yyyy")
                </GridColumn>

                <GridColumn TItem="Customer" HeaderText="Aktionen" Filterable="false" Sortable="false">
                    <button class="icon-btn tabel-del-btn"
                            @onclick="() => DeleteCustomer(context.Id)"
                            @onclick:stopPropagation="true"
                            title="Löschen">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </GridColumn>
            </GridColumns>
        </Grid>
    </div>
</div>
<div id="splitter"></div>
<div class="detail-group-div">
    <div class="kunden-details-group">
        <div class="detail-container">
            <label for="name">Name</label>
            <select id="name" name="name" aria-placeholder="Titel" class="firma-select" @bind="CurrentCustomer.Title">
                <option value="">– Titel wählen –</option>
                <option value="Herr">Herr</option>
                <option value="Frau">Frau</option>
            </select>
            <input type="text" @bind="CurrentCustomer.Contact.Firstname" placeholder="Vorname" class="name-input" />
            <input type="text" @bind="CurrentCustomer.Contact.Surname" placeholder="Nachname" class="name-input" />
        </div>
        <div>
            <label for="adresse">Adresse</label>
            <input type="text" @bind="CurrentCustomer.Address.Street" placeholder="Straße" class="adresse-input" />
            <input type="text" @bind="PlzOrt" placeholder="PLZ und Ort" class="adresse-input" />
        </div>
        <div>
            <label for="land">Land</label>
            <InputSelectCountry Items="countries"
                    class="land-select"
                    @bind-Value="CurrentCustomer.Address.Country" />
            <img src="@SelectedFlagPath" class="flag-icon" />
            <label>Geb</label>
            <input type="date" @bind="CurrentCustomer.Birthdate" class="geb-input" />
            <input type="number" value="@CurrentCustomer.Age" disabled class="alter-input" />
        </div>
        <div>
            <label for="kontakt">Kontakt</label>
            <input type="email" @bind="CurrentCustomer.Mail" placeholder="E-Mail" class="kontakt-input" />
            <input type="tel" @bind="CurrentCustomer.Contact.Phonenumber" placeholder="Telefon" class="kontakt-input" />
        </div>
        <div>
            <label for="notfall" class="notfall-label">NOTFALL</label>
            <input type="email" @bind="NotfallContact" placeholder="Notfallkontakt" class="kontakt-input" />
            <input type="tel" @bind="CurrentCustomer.NotfallContact.Phonenumber" placeholder="Notfalltelefon" class="kontakt-input" />

        </div>
        <div>
            <label>UID</label>
            <input type="text" @bind="CurrentCustomer.UID" placeholder="UID" class="uid-input" />
            <label>Sponsor</label>
            <input type="text" @bind="CurrentCustomer.Sponsor" placeholder="Sponsor" class="sponsor-input" />
        </div>
        <div class="checkbox-wrapper">
            <label>TC5K</label>
            <input type="checkbox"
                   checked="@Tc5kParticipates"
                   @onchange="(e) => ToggleParticipatesTc5k((bool)e.Value!)" />

            <label>Teamchef</label>
            <input type="checkbox"
                   checked="@Tc5kIsTeamChef"
                   @onchange="(e) => ToggleTeamchefTc5k((bool)e.Value!)"
                   disabled="@(!Tc5kParticipates || Tc5kTeam == null)" />

            <label>Team</label>
            <InputSelectTeam @bind-Value="Tc5kTeam"
                             Items="AllTeams"
                             class="team-select"
                             disabled="@(!Tc5kParticipates)" />
        </div>
        <div class="checkbox-wrapper">
            <label>END Cup</label>
            <input type="checkbox"
                   checked="@EndParticipates"
                   @onchange="(e) => ToggleParticipatesEnd((bool)e.Value!)" />

            <label>Teamchef</label>
            <input type="checkbox"
                   checked="@EndIsTeamChef"
                   @onchange="(e) => ToggleTeamchefEnd((bool)e.Value!)"
                   disabled="@(!EndParticipates || EndTeam == null)" />

            <label>Team</label>
            <InputSelectTeam @bind-Value="EndTeam"
                             Items="AllTeams"
                             class="team-select"
                             disabled="@(!EndParticipates)" />
        </div>
        <div>
            <label>Guthaben</label>
            <input type="number" @bind="CurrentCustomer.Guthaben" placeholder="Guthaben" style="width:5rem;"/>
            <input type="date" @bind="CurrentCustomer.LastGuthabenAdd" />
            <input type="number" @bind="CurrentCustomer.LastGuthabenAddNumber" placeholder="Betrag" />
            <input type="text" @bind="CurrentCustomer.GuthabenComment" placeholder="Bemerkung" />
        </div>
        <div class="extra-wrapper">
            <label>Preisgeld</label>
            <input type="number" @bind="CurrentCustomer.Preisgeld" placeholder="Preisgeld" />
            <label>Gratisfahrer</label>
            <input type="number" @bind="CurrentCustomer.Gratisfahrer" placeholder="Gratisfahrer" />
            <label>Schurke</label>
            <input type="number" @bind="CurrentCustomer.Schurke" placeholder="Schurke" />
            <label>Verzicht OK</label>
            <input type="checkbox" @bind="CurrentCustomer.VerzichtOk" />
        </div>
        <div>
            <label>Gruppe</label>
            <InputSelectGruppe @bind-Value="CurrentCustomer.Gruppe"
                         Items="gruppen"
                         TextSelector="g => g.Name"
                         class="gruppe-select" />
            
            <label>Beste Zeit</label>
            <input type="text" @bind="BestTimeInput" placeholder="z.B. 2:15,5 oder 2:15,50" 
                   pattern="^([0-5]?[0-9]):([0-5][0-9]),([0-9]{1,2})$" 
                   title="Format: mm:ss,h oder mm:ss,hh (z.B. 2:15,5 oder 2:15,50)" />
        </div>
    </div>
    <div class="bike-race-group">
        <div>
            <div class="bike-wrapper">
                <label>Bike</label>
                <InputSelectBrand @bind-Value="CurrentCustomer.Bike.Brand"
                    Items="brands"
                    class="land-select" />
                <label>Type</label>
                <input type="text" @bind="CurrentCustomer.Bike.Type" placeholder="Type" />
                <label>Klasse</label>
                <input type="text" @bind="CurrentCustomer.Bike.Ccm" placeholder="Klasse" />
                <label>Kunde seit</label>
                <input type="date" @bind="CurrentCustomer.Validfrom" />
             </div>
             <div class="bike-wrapper2">
                <label>Baujahr</label>
                <input type="number" @bind="CurrentCustomer.Bike.Year" placeholder="Baujahr" />
                <label>Tran</label>
                <InputSelectTransponder @bind-Value="CurrentCustomer.Transponder"
                                        Items="transponders"
                                        class="land-select" />
                <label>Tran Id</label>
                <input type="text"
                       value="@CurrentCustomer.Transponder?.Number"
                       class="tran-id" />
                <label class="letzte-buch-label">Letzte Buchung</label>
                <input type="date" @bind="CurrentCustomer.letzteBuchung" placeholder="Letzte Buchung" />
             </div>
             <div class="bike-wrapper3">
                <label>Start #</label>
                <input type="text" @bind="CurrentCustomer.Startnumber" placeholder="Start #" />
                <label class="s8s-label">S8S</label>
                <input type="text" @bind="CurrentCustomer.S8S" placeholder="S8S" />
                <label>Speeddays</label>
                <input type="text" @bind="CurrentCustomer.Speeddays" placeholder="Speeddays" />
                <label class="letzte-einkauf-label">Letzter Einkauf</label>
                <input type="date" @bind="CurrentCustomer.letzterEinkauf" placeholder="Letzter Einkauf" />
             </div>
        </div>
        <div class="j-l-container">
            <div>
                <p>Jahreswertung:</p>
                <div class="cup-container">
                    <div class="cup-field">
                        @foreach (var vm in cups)
                        {
                            <div class="checkbox-wrapper">
                                <label>@vm.Name</label>
                                <input type="checkbox"/>
                            </div>
                        }
                        </div>
                    </div>
            </div>
            <div class="laptime-container">
                <div class="laptime-field">
                    <label>BRN</label>
                    <input type="text" placeholder="BRN (mm:ss,ss)" />
                </div>
                <div class="laptime-field">
                    <label>MUG</label>
                    <input type="text" placeholder="MUG (mm:ss,ss)" />
                </div>
                <div class="laptime-field">
                    <label>CRE</label>
                    <input type="text" placeholder="CRE (mm:ss,ss)" />
                </div>
                <div class="laptime-field">
                    <label>PAN</label>
                    <input type="text" placeholder="PAN (mm:ss,ss)" />
                </div>
                <div class="laptime-field">
                    <label>HUN</label>
                    <input type="text" placeholder="HUN (mm:ss,ss)" />
                </div>
                <div class="laptime-field">
                    <label>RBR</label>
                    <input type="text" placeholder="RBR (mm:ss,ss)" />
                </div>
                <div class="laptime-field">
                    <label>LAU</label>
                    <input type="text" placeholder="LAU (mm:ss,ss)" />
                </div>
                <div class="laptime-field">
                    <label>RIJ</label>
                    <input type="text" placeholder="RIJ (mm:ss,ss)" />
                </div>
                <div class="laptime-field">
                    <label>MST</label>
                    <input type="text" placeholder="MST (mm:ss,ss)" />
                </div>
                <div class="laptime-field">
                    <label>SLO</label>
                    <input type="text" placeholder="SLO (mm:ss,ss)" />
                </div>
            </div>
        </div>
        <div class="btn-column">
            <button class="filter-btn" @onclick="SaveCustomerAsync">Speichern</button>
            <button class="filter-btn">Mail senden</button>
            <button class="filter-btn">Mail archiv</button>
            <button class="filter-btn">Kundenmails</button>
        </div>
        
        @if (!string.IsNullOrWhiteSpace(Message))
        {
            <div class="col-12">
                <div class="alert alert-info mt-2">
                    <span>@Message</span>
                    <button type="button" class="btn-close" @onclick="@(() => Message = null)"></button>
                </div>
            </div>
        }
    </div>   
</div>