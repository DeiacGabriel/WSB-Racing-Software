@page "/management/transponder"
@using WSB_Management.Models
@using WSB_Management.Services
@using MudBlazor


<PageTitle>WSB-Sport - Transponder</PageTitle>

<style>
    .transponder-card { transition: all 0.2s; cursor: pointer; }
    .transponder-card:hover { background-color: #e3f2fd !important; }
    .transponder-card.selected { background-color: #bbdefb !important; border-left: 4px solid #1976d2; }
</style>

<div class="container-fluid p-3">
    @* Header *@
    <MudPaper Class="pa-3 mb-3" Elevation="2">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center gap-3">
                <MudIcon Icon="@Icons.Material.Filled.Sensors" Size="Size.Large" Color="Color.Primary" />
                <div>
                    <MudText Typo="Typo.h5" Class="fw-bold">Transponder Verwaltung</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @Transponders.Count Transponder registriert
                    </MudText>
                </div>
            </div>
            
            <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Add"
                       OnClick="@AddNew">
                Neuer Transponder
            </MudButton>
        </div>
    </MudPaper>
    
    <div class="row">
        @* Liste *@
        <div class="@(SelectedTransponder != null ? "col-12 col-md-6 col-lg-8" : "col-12")">
            <MudPaper Class="pa-0" Elevation="2">
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                    <MudText Typo="Typo.h6">Transponderliste</MudText>
                    <MudTextField T="string" @bind-Value="SearchText" Placeholder="Suchen..."
                                  Variant="Variant.Outlined" Margin="Margin.Dense" Style="width: 200px;"
                                  Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true" />
                </div>
                
                <div style="max-height: 600px; overflow-y: auto;">
                    <MudSimpleTable Dense="true" Hover="true">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th style="width: 60px;">ID</th>
                                <th>Bezeichnung</th>
                                <th>Nummer</th>
                                <th style="width: 80px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var t in FilteredTransponders)
                            {
                                var isSelected = SelectedTransponder?.Id == t.Id;
                                <tr class="transponder-card @(isSelected ? "selected" : "")"
                                    @onclick="@(() => Select(t))"
                                    style="cursor: pointer;">
                                    <td><MudChip T="string" Size="Size.Small" Color="Color.Primary">@t.Id</MudChip></td>
                                    <td class="fw-bold">@t.Bezeichung</td>
                                    <td>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Class="font-monospace">
                                            @t.Number
                                        </MudChip>
                                    </td>
                                    <td @onclick:stopPropagation="true">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary"
                                                       OnClick="@(() => Select(t))" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                                       OnClick="@(() => Delete(t.Id))" />
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                </div>
                
                @if (!FilteredTransponders.Any())
                {
                    <div class="text-center py-5 text-muted">
                        <MudIcon Icon="@Icons.Material.Filled.SensorsOff" Size="Size.Large" />
                        <MudText>Keine Transponder gefunden</MudText>
                    </div>
                }
            </MudPaper>
        </div>
        
        @* Detail Panel *@
        @if (SelectedTransponder != null)
        {
            <div class="col-12 col-md-6 col-lg-4 mt-3 mt-md-0">
                <MudPaper Class="pa-4" Elevation="3" Style="border-left: 4px solid #1976d2;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <MudText Typo="Typo.h6">
                            @(IsNew ? "Neuer Transponder" : "Transponder bearbeiten")
                        </MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="@CloseDetail" />
                    </div>
                    
                    <MudGrid>
                        <MudItem xs="12">
                            <MudTextField T="string" @bind-Value="SelectedTransponder.Bezeichung" Label="Bezeichnung"
                                          Variant="Variant.Outlined" Margin="Margin.Dense" FullWidth="true"
                                          HelperText="z.B. Leih-Transponder 1, Eigener Transponder" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField T="string" @bind-Value="SelectedTransponder.Number" Label="Nummer"
                                          Variant="Variant.Outlined" Margin="Margin.Dense" FullWidth="true"
                                          HelperText="Eindeutige Transpondernummer" />
                        </MudItem>
                    </MudGrid>
                    
                    <div class="d-flex gap-2 mt-4">
                        <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.Save" OnClick="@Save">
                            Speichern
                        </MudButton>
                    </div>
                    
                    @if (!string.IsNullOrWhiteSpace(Message))
                    {
                        <MudAlert Severity="@(Message.Contains("Fehler") ? Severity.Error : Severity.Success)" 
                                  Class="mt-3" Dense="true">@Message</MudAlert>
                    }
                </MudPaper>
            </div>
        }
    </div>
</div>
