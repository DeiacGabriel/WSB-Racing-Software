@page "/management/groups"
@using WSB_Management.Models
@using WSB_Management.Services
@using MudBlazor


<PageTitle>WSB-Sport - Gruppen</PageTitle>

<style>
    .group-card { transition: all 0.2s; cursor: pointer; }
    .group-card:hover { background-color: #e3f2fd !important; }
    .group-card.selected { background-color: #bbdefb !important; border-left: 4px solid #1976d2; }
</style>

<div class="container-fluid p-3">
    @* Header *@
    <MudPaper Class="pa-3 mb-3" Elevation="2">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center gap-3">
                <MudIcon Icon="@Icons.Material.Filled.Groups" Size="Size.Large" Color="Color.Primary" />
                <div>
                    <MudText Typo="Typo.h5" Class="fw-bold">Gruppen Verwaltung</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @Gruppen.Count Gruppen definiert
                    </MudText>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <MudButton Variant="Variant.Outlined" Color="Color.Warning" StartIcon="@Icons.Material.Filled.AutoAwesome"
                           OnClick="@AutoAssign">
                    Auto-Zuweisung
                </MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Add"
                           OnClick="@AddNew">
                    Neue Gruppe
                </MudButton>
            </div>
        </div>
    </MudPaper>
    
    @* Info Alert für Auto-Zuweisung *@
    @if (!string.IsNullOrWhiteSpace(AutoAssignMessage))
    {
        <MudAlert Severity="Severity.Info" Class="mb-3" ShowCloseIcon="true"
                  CloseIconClicked="@(() => AutoAssignMessage = null)">
            @AutoAssignMessage
        </MudAlert>
    }
    
    <div class="row">
        @* Liste *@
        <div class="@(SelectedGruppe != null ? "col-12 col-md-6 col-lg-8" : "col-12")">
            <MudPaper Class="pa-0" Elevation="2">
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                    <MudText Typo="Typo.h6">Gruppenliste</MudText>
                </div>
                
                <MudSimpleTable Dense="true" Hover="true">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Max. Rundenzeit</th>
                            <th style="width: 100px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var gruppe in Gruppen)
                        {
                            var isSelected = SelectedGruppe?.Id == gruppe.Id;
                            <tr class="group-card @(isSelected ? "selected" : "")"
                                @onclick="@(() => Select(gruppe))"
                                style="cursor: pointer;">
                                <td><MudChip T="string" Size="Size.Small" Color="Color.Primary">@gruppe.Id</MudChip></td>
                                <td>
                                    <MudChip T="string" Size="Size.Small" Color="@GetGroupColor(gruppe.Name)">
                                        @gruppe.Name
                                    </MudChip>
                                </td>
                                <td>
                                    @if (gruppe.MaxTimelap.HasValue)
                                    {
                                        <span class="font-monospace">@gruppe.MaxTimelap.Value.ToString(@"m\:ss\.ff")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Keine Begrenzung</span>
                                    }
                                </td>
                                <td @onclick:stopPropagation="true">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary"
                                                   OnClick="@(() => Select(gruppe))" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                                   OnClick="@(() => Delete(gruppe.Id))" />
                                </td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
                
                @if (!Gruppen.Any())
                {
                    <div class="text-center py-5 text-muted">
                        <MudIcon Icon="@Icons.Material.Filled.GroupOff" Size="Size.Large" />
                        <MudText>Keine Gruppen definiert</MudText>
                    </div>
                }
            </MudPaper>
        </div>
        
        @* Detail Panel *@
        @if (SelectedGruppe != null)
        {
            <div class="col-12 col-md-6 col-lg-4 mt-3 mt-md-0">
                <MudPaper Class="pa-4" Elevation="3" Style="border-left: 4px solid #1976d2;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <MudText Typo="Typo.h6">
                            @(IsNew ? "Neue Gruppe" : "Gruppe bearbeiten")
                        </MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="@CloseDetail" />
                    </div>
                    
                    <MudGrid>
                        <MudItem xs="12">
                            <MudTextField T="string" @bind-Value="SelectedGruppe.Name" Label="Gruppenname"
                                          Variant="Variant.Outlined" Margin="Margin.Dense"
                                          HelperText="z.B. A, B, C oder Schnell, Mittel, Langsam" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField T="string" @bind-Value="MaxTimeString" Label="Max. Rundenzeit"
                                          Variant="Variant.Outlined" Margin="Margin.Dense"
                                          Placeholder="m:ss,hh" HelperText="z.B. 2:30,00 - Fahrer schneller als diese Zeit gehören in die Gruppe" />
                        </MudItem>
                    </MudGrid>
                    
                    <MudAlert Severity="Severity.Info" Dense="true" Class="mt-3">
                        <MudText Typo="Typo.body2">
                            Die Max. Rundenzeit wird für die automatische Gruppenzuweisung verwendet. 
                            Fahrer mit einer besseren Zeit werden dieser Gruppe zugewiesen.
                        </MudText>
                    </MudAlert>
                    
                    <div class="d-flex gap-2 mt-4">
                        <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.Save" OnClick="@Save">
                            Speichern
                        </MudButton>
                    </div>
                    
                    @if (!string.IsNullOrWhiteSpace(Message))
                    {
                        <MudAlert Severity="@(Message.Contains("Fehler") ? Severity.Error : Severity.Success)" 
                                  Class="mt-3" Dense="true">@Message</MudAlert>
                    }
                </MudPaper>
            </div>
        }
    </div>
</div>
