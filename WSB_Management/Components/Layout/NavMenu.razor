@using Microsoft.AspNetCore.Components.Routing
@using System.Linq
@inject NavigationManager Nav
@inherits LayoutComponentBase
@implements IDisposable

<div class="navbar-custom">
    <NavLink href="/customer" class="nav-item" ActiveClass="active" Match="NavLinkMatch.Prefix">
        <span class="material-symbols-outlined">group</span> Kunden
    </NavLink>
    <NavLink href="/races" class="nav-item" ActiveClass="active" Match="NavLinkMatch.Prefix">
        <span class="material-symbols-outlined">
            assignment
        </span> Rennen
    </NavLink>
    <NavLink href="/calendar" class="nav-item" ActiveClass="active" Match="NavLinkMatch.Prefix">
        <span class="material-symbols-outlined">
            calendar_month
        </span> Kalender
    </NavLink>
    <NavLink href="/events" class="nav-item" ActiveClass="active" Match="NavLinkMatch.Prefix">
        <span class="material-symbols-outlined">tv</span> Events
    </NavLink>
    <NavLink href="/rankings" class="nav-item" ActiveClass="active" Match="NavLinkMatch.Prefix">
        <span class="material-symbols-outlined">hourglass_empty</span> Rankings
    </NavLink>
    <NavLink href="/statistics" class="nav-item" ActiveClass="active" Match="NavLinkMatch.Prefix">
        <span class="material-symbols-outlined">bar_chart</span> Statistiken
    </NavLink>

    <!-- Dropdown Stammdaten -->
    <Dropdown Class="nav-item dropdown">
        <DropdownToggleButton Class="@($"dropdown-toggle {(IsMgmtActive ? "active" : "")}")">
            <span class="material-symbols-outlined">list</span>
            <span>Stammdaten</span>
        </DropdownToggleButton>

        <DropdownMenu>
            @foreach (var o in MgmtOptions)
            {
                <DropdownItem
                    To="@o.Path"
                    Type="DropdownItemType.Link"
                    Class="nav-item"
                    Active="@IsPathActive(o.Path)">
                    @o.Label
                </DropdownItem>
            }
        </DropdownMenu>
    </Dropdown>

    <NavLink href="/settings" class="nav-item" ActiveClass="active" Match="NavLinkMatch.Prefix">
        <span class="material-symbols-outlined">settings</span> Einstellungen
    </NavLink>
</div>

@code {
    private record MgmtItem(string Label, string Path);

    private readonly MgmtItem[] MgmtOptions = new[] {
        new MgmtItem("Events",      "/management/events"),
        new MgmtItem("Gruppen",      "/management/groups"),
        new MgmtItem("Transponder", "/management/transponder"),
        new MgmtItem("Länder",      "/management/countries"),
        new MgmtItem("Marken",      "/management/brands"),
    };

    private bool IsMgmtActive => new Uri(Nav.Uri).AbsolutePath
        .StartsWith("/management", StringComparison.OrdinalIgnoreCase);

    private bool IsPathActive(string path) =>
        new Uri(Nav.Uri).AbsolutePath.StartsWith(path, StringComparison.OrdinalIgnoreCase);

    protected override void OnInitialized()
    {
        Nav.LocationChanged += HandleLocationChanged;
    }

    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        // Damit Active-Styles sofort updaten
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Nav.LocationChanged -= HandleLocationChanged;
    }
}
