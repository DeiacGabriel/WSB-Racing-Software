@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using WSB_Management.Data
@using WSB_Management.Models
@using WSB_Management.Services
@using MudBlazor
@inject NavigationManager Nav
@inject IDbContextFactory<WSBRacingDbContext> DbFactory
@inject EventService EventService
@inject CustomAuthStateProvider AuthStateProvider
@implements IDisposable

<MudAppBar Elevation="2" Dense="true" Class="navbar-mud" Style="background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);">
    <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" 
                   OnClick="@ToggleDrawer" Class="d-lg-none" />
    
    <MudImage Src="WSB_Logo.png" Alt="WSB Sport" Width="40" Height="40" Class="me-2" />
    <MudText Typo="Typo.h6" Class="fw-bold d-none d-md-block">WSB Racing</MudText>
    
    <MudSpacer />
    
    @* Desktop Navigation *@
    <div class="d-none d-lg-flex align-items-center gap-1">
        
        <MudButton Href="/customer" Color="Color.Inherit" StartIcon="@Icons.Material.Filled.People"
                   Class="@GetNavClass("/customer")">
            KUNDEN
        </MudButton>
        
        <MudMenu AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter"
                 Class="@GetNavClass("/events")">
            <ActivatorContent>
                <MudButton Color="Color.Inherit" 
                           StartIcon="@Icons.Material.Filled.SportsMotorsports"
                           EndIcon="@Icons.Material.Filled.KeyboardArrowDown">
                    EVENT
                </MudButton>
            </ActivatorContent>
            <ChildContent>
                @foreach (var ev in EventOptions)
                {
                    <MudMenuItem Href="@($"/events/{ev.Id}")">
                        <div class="d-flex align-items-center gap-2">
                            <MudIcon Icon="@Icons.Material.Filled.Flag" Size="Size.Small" Color="Color.Primary" />
                            @ev.Name
                        </div>
                    </MudMenuItem>
                }
                @if (!EventOptions.Any())
                {
                    <MudMenuItem Disabled="true">Keine Events vorhanden</MudMenuItem>
                }
                <MudDivider />
                <MudMenuItem OnClick="@LoadEvents">
                    <div class="d-flex align-items-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" />
                        Aktualisieren
                    </div>
                </MudMenuItem>
            </ChildContent>
        </MudMenu>
        
        <MudButton Href="/calendar" Color="Color.Inherit" StartIcon="@Icons.Material.Filled.CalendarMonth"
                   Class="@GetNavClass("/calendar")">
            KALENDER
        </MudButton>
        
        <MudButton Href="/rankings" Color="Color.Inherit" StartIcon="@Icons.Material.Filled.EmojiEvents"
                   Class="@GetNavClass("/rankings")">
            RANKINGS
        </MudButton>
        
        <MudMenu AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter"
                 Class="@GetNavClass("/management")">
            <ActivatorContent>
                <MudButton Color="Color.Inherit" 
                           StartIcon="@Icons.Material.Filled.Storage"
                           EndIcon="@Icons.Material.Filled.KeyboardArrowDown">
                    STAMMDATEN
                </MudButton>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem Href="/management/events">
                    <div class="d-flex align-items-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" Color="Color.Primary" />
                        Events
                    </div>
                </MudMenuItem>
                <MudMenuItem Href="/management/groups">
                    <div class="d-flex align-items-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.Groups" Size="Size.Small" Color="Color.Success" />
                        Gruppen
                    </div>
                </MudMenuItem>
                <MudMenuItem Href="/management/transponder">
                    <div class="d-flex align-items-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.Sensors" Size="Size.Small" Color="Color.Warning" />
                        Transponder
                    </div>
                </MudMenuItem>
                <MudMenuItem Href="/management/countries">
                    <div class="d-flex align-items-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.Flag" Size="Size.Small" Color="Color.Error" />
                        Länder
                    </div>
                </MudMenuItem>
                <MudMenuItem Href="/management/brands">
                    <div class="d-flex align-items-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.BusinessCenter" Size="Size.Small" Color="Color.Default" />
                        Marken
                    </div>
                </MudMenuItem>
                <MudMenuItem Href="/management/types">
                    <div class="d-flex align-items-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.TwoWheeler" Size="Size.Small" Color="Color.Info" />
                        Typen und Klassen von Motorrädern
                    </div>
                </MudMenuItem>
                </ChildContent>
        </MudMenu>
        
        <MudMenu AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter"
                 Class="@GetNavClass("/settings")">
            <ActivatorContent>
                <MudButton Color="Color.Inherit" 
                           StartIcon="@Icons.Material.Filled.Settings"
                           EndIcon="@Icons.Material.Filled.KeyboardArrowDown">
                    EINSTELLUNGEN
                </MudButton>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem Href="/settings">
                    <div class="d-flex align-items-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.Tune" Size="Size.Small" Color="Color.Primary" />
                        Allgemein
                    </div>
                </MudMenuItem>
                <MudMenuItem Href="/settings/users">
                    <div class="d-flex align-items-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Size="Size.Small" Color="Color.Warning" />
                        Benutzerverwaltung
                    </div>
                </MudMenuItem>
                <MudDivider />
                <MudMenuItem OnClick="@HandleLogout">
                    <div class="d-flex align-items-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.Logout" Size="Size.Small" Color="Color.Error" />
                        Abmelden
                    </div>
                </MudMenuItem>
            </ChildContent>
        </MudMenu>
    </div>
</MudAppBar>

@* Mobile Drawer *@
<MudDrawer @bind-Open="_drawerOpen" Elevation="1" Variant="DrawerVariant.Temporary" ClipMode="DrawerClipMode.Always">
    <MudDrawerHeader>
        <div class="d-flex align-items-center gap-2">
            <MudImage Src="WSB_Logo.png" Alt="WSB Sport" Width="40" Height="40" />
            <MudText Typo="Typo.h6">WSB Racing</MudText>
        </div>
    </MudDrawerHeader>
    <MudNavMenu>
        <MudNavLink Href="/customer" Icon="@Icons.Material.Filled.People" Match="NavLinkMatch.Prefix">
            Kunden
        </MudNavLink>
        
        <MudNavGroup Title="Event" Icon="@Icons.Material.Filled.SportsMotorsports" Expanded="@_eventsExpanded">
            @foreach (var ev in EventOptions)
            {
                <MudNavLink Href="@($"/events/{ev.Id}")" Icon="@Icons.Material.Filled.Flag">
                    @ev.Name
                </MudNavLink>
            }
        </MudNavGroup>
        
        <MudNavLink Href="/calendar" Icon="@Icons.Material.Filled.CalendarMonth" Match="NavLinkMatch.Prefix">
            Kalender
        </MudNavLink>
        
        <MudNavLink Href="/rankings" Icon="@Icons.Material.Filled.EmojiEvents" Match="NavLinkMatch.Prefix">
            Rankings
        </MudNavLink>
        
        <MudNavGroup Title="Stammdaten" Icon="@Icons.Material.Filled.Storage" Expanded="@_mgmtExpanded">
            <MudNavLink Href="/management/events" Icon="@Icons.Material.Filled.Event">Events</MudNavLink>
            <MudNavLink Href="/management/groups" Icon="@Icons.Material.Filled.Groups">Gruppen</MudNavLink>
            <MudNavLink Href="/management/transponder" Icon="@Icons.Material.Filled.Sensors">Transponder</MudNavLink>
            <MudNavLink Href="/management/countries" Icon="@Icons.Material.Filled.Flag">Länder</MudNavLink>
            <MudNavLink Href="/management/brands" Icon="@Icons.Material.Filled.DirectionsBike">Marken</MudNavLink>
            <MudNavLink Href="/management/types" Icon="@Icons.Material.Filled.TwoWheeler">Motorrad Typen</MudNavLink>
        </MudNavGroup>
        
        <MudNavGroup Title="Einstellungen" Icon="@Icons.Material.Filled.Settings" Expanded="@_settingsExpanded">
            <MudNavLink Href="/settings" Icon="@Icons.Material.Filled.Tune">Allgemein</MudNavLink>
            <MudNavLink Href="/settings/users" Icon="@Icons.Material.Filled.AdminPanelSettings">Benutzer</MudNavLink>
            <MudNavLink Icon="@Icons.Material.Filled.Logout" OnClick="@HandleLogout">Abmelden</MudNavLink>
        </MudNavGroup>
    </MudNavMenu>
</MudDrawer>

@code {
    private bool _drawerOpen;
    private bool _eventsExpanded = true;
    private bool _mgmtExpanded;
    private bool _settingsExpanded;
    private List<Event> EventOptions = new();
    
    private void ToggleDrawer() => _drawerOpen = !_drawerOpen;
    
    private string GetNavClass(string path)
    {
        var currentPath = new Uri(Nav.Uri).AbsolutePath;
        var isActive = currentPath.StartsWith(path, StringComparison.OrdinalIgnoreCase);
        return isActive ? "nav-active" : "";
    }
    
    protected override async Task OnInitializedAsync()
    {
        Nav.LocationChanged += HandleLocationChanged;
        EventService.EventsChanged += OnEventsChanged;
        await LoadEvents();
    }
    
    private async Task LoadEvents()
    {
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            EventOptions = await db.Events
                .AsNoTracking()
                .OrderBy(e => e.Validfrom)
                .ToListAsync();
        }
        catch
        {
            EventOptions = new List<Event>();
        }
    }
    
    private async void OnEventsChanged()
    {
        await LoadEvents();
        await InvokeAsync(StateHasChanged);
    }
    
    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        _drawerOpen = false;
        InvokeAsync(StateHasChanged);
    }
    
    private async Task HandleLogout()
    {
        await AuthStateProvider.LogoutAsync();
        Nav.NavigateTo("/login", forceLoad: true);
    }
    
    public void Dispose()
    {
        Nav.LocationChanged -= HandleLocationChanged;
        EventService.EventsChanged -= OnEventsChanged;
    }
}

<style>
    .navbar-mud .nav-active {
        background-color: rgba(255, 255, 255, 0.15) !important;
        border-radius: 4px;
    }
    .navbar-mud .mud-button-root:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
</style>
